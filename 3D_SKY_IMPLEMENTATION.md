# 3D 밤하늘 공간 구현 현황

> 최종 업데이트: 2026-01-28

## 개요

사용자들이 자신의 별자리를 공용 3D 밤하늘에 등록하고, 다른 사람들의 별자리와 함께 감상할 수 있는 기능

### 핵심 컨셉
- **단일 밤하늘**: 모든 사용자가 하나의 밤하늘 공유
- **무제한 수용**: 인원 제한 없음
- **선착순 위치 선점**: 원하는 위치에 먼저 등록한 사람이 차지
- **영구 보존**: 한번 등록된 별자리는 계속 유지

### 별자리 제작 vs 등록 (분리)
| 구분 | 페이지 | 설명 |
|------|--------|------|
| 별자리 제작 | HomePage (기존) | 내 별자리 만들기/수정 |
| 밤하늘 등록 | 3D 밤하늘 페이지 | 만든 별자리를 공용 하늘에 배치 |

### 사용자 실행 순서

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 별자리 제작 (HomePage - 기존 기능)                            │
│     └── 내 별자리 만들기/수정                                    │
│                                                                  │
│  2. 3D 밤하늘 버튼 클릭                                          │
│     └── 3D 밤하늘 페이지로 이동                                  │
│                                                                  │
│  3. 3D 밤하늘 페이지                                             │
│     ┌─────────────────────────────────────────────┐             │
│     │  밤하늘 (3D 뷰어)                            │             │
│     │  - 드래그/자이로로 360° 둘러보기              │             │
│     │  - 등록된 별자리들 감상                       │             │
│     │  - 별자리 터치 → 제작자 정보                  │             │
│     │                                              │             │
│     │  [내 별자리 등록] 버튼                        │             │
│     │  └── 3D 하늘에서 위치 선택 (적경/적위)        │             │
│     │      └── 빈 위치면 등록 완료!                 │             │
│     │      └── 이미 있으면 등록 불가 (선착순)       │             │
│     └─────────────────────────────────────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

### 3D 뷰어 조작 방법
| 조작 | 동작 |
|------|------|
| 화면 드래그 | 시점 회전 (상하좌우) |
| 핸드폰 기울이기 | 자이로스코프로 시점 이동 |
| 별자리 터치 | 제작자 정보 팝업 |

### 위치 선택 (천구 좌표)
- **적경 (Right Ascension)**: 0° ~ 360° (하늘의 경도)
- **적위 (Declination)**: -90° ~ +90° (하늘의 위도)
- **충돌 판정**: 일정 반경 내에 다른 별자리 있으면 등록 불가

### 별자리 등록 UI (하이브리드 방식)

```
┌─────────────────────────────────────────────────────────────────┐
│  [등록하기] 버튼 클릭                                            │
│       ↓                                                         │
│  ┌─────────────────────────────────────────────┐               │
│  │         🌟 등록 모드 진입 🌟                  │               │
│  │                                              │               │
│  │  3D 하늘을 둘러보며 원하는 위치를 터치하세요   │               │
│  │                                              │               │
│  │  • 빈 곳 터치 → 미리보기 표시                 │               │
│  │  • 다른 별자리 근처 → "너무 가까워요" 경고     │               │
│  │                                              │               │
│  │  ┌─────────────────────────────────────┐    │               │
│  │  │  [빈 자리 자동 찾기]  [취소]         │    │               │
│  │  └─────────────────────────────────────┘    │               │
│  └─────────────────────────────────────────────┘               │
│       ↓                                                         │
│  위치 선택 완료                                                  │
│       ↓                                                         │
│  ┌─────────────────────────────────────────────┐               │
│  │  이 위치에 별자리를 등록할까요?               │               │
│  │                                              │               │
│  │  📍 적경: 142.5° / 적위: 35.2°               │               │
│  │  ⭐ 내 별자리 미리보기                        │               │
│  │                                              │               │
│  │  [등록하기]              [다시 선택]          │               │
│  └─────────────────────────────────────────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

#### 등록 모드 동작
| 동작 | 결과 |
|------|------|
| 빈 하늘 터치 | 내 별자리 미리보기 표시 + 확인 팝업 |
| 다른 별자리 근처 터치 | "이 위치는 이미 사용 중입니다" 안내 |
| [빈 자리 자동 찾기] | 시스템이 빈 위치 찾아서 자동 이동 |
| 드래그 | 시점 이동 (기존과 동일) |

---

## 구현 진행 상황

### Phase 1: 기반 설정
| 작업 | 상태 | 비고 |
|------|------|------|
| Three.js 라이브러리 설치 | [x] 완료 | three, @react-three/fiber, @react-three/drei |
| sky_constellations 테이블 생성 | [x] 완료 | SQL 마이그레이션 파일 생성 |

### Phase 2: 3D 뷰어 개발
| 작업 | 상태 | 비고 |
|------|------|------|
| 3D 구형 하늘 컴포넌트 | [x] 완료 | SkyPage.jsx |
| 별자리 3D 렌더링 | [x] 완료 | Sprite 기반, 참고코드 1.html 스타일 |
| 드래그로 시점 이동 | [x] 완료 | OrbitControls |
| 자이로스코프 연동 | [x] 완료 | AR 카메라 스타일, DeviceOrientation API |

### Phase 3: 페이지 & UI
| 작업 | 상태 | 비고 |
|------|------|------|
| 3D 밤하늘 메인 페이지 | [x] 완료 | /sky (SkyPage.jsx) |
| 등록 모드 UI | [x] 완료 | 3D 터치로 위치 선택 |
| 빈 자리 자동 찾기 | [x] 완료 | 버튼 클릭 시 빈 위치로 이동 |
| 등록 확인 팝업 | [x] 완료 | 미리보기 + 확인/취소 |

### Phase 4: 기능 완성
| 작업 | 상태 | 비고 |
|------|------|------|
| 내 별자리 불러오기 | [x] 완료 | 기존 stars 테이블 연동 |
| 위치 충돌 검사 | [x] 완료 | 15도 충돌 반경 |
| 별자리 터치 정보 표시 | [x] 완료 | 제작자 닉네임 표시 |
| Supabase 연동 | [x] 완료 | 등록/조회 API |

---

## 데이터베이스 스키마

### sky_constellations (등록된 별자리)
```sql
CREATE TABLE sky_constellations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- 별자리 데이터 (기존 형식 재사용)
  constellation_name VARCHAR(100),
  stars_data JSONB NOT NULL,
  connections_data JSONB,

  -- 3D 하늘 위치 (천구 좌표)
  right_ascension FLOAT NOT NULL,     -- 적경 (0-360도)
  declination FLOAT NOT NULL,         -- 적위 (-90 ~ +90도)

  registered_at TIMESTAMPTZ DEFAULT NOW(),

  -- 한 사람당 하나의 별자리만
  UNIQUE(user_id)
);
```

---

## 기술 스택

### 설치된 라이브러리
```json
{
  "three": "설치됨",
  "@react-three/fiber": "설치됨",
  "@react-three/drei": "설치됨"
}
```

### 사용할 API
| API | 용도 |
|-----|------|
| DeviceOrientation | 자이로스코프 (핸드폰 기울기) |
| Supabase Realtime | 실시간 별자리 동기화 (옵션) |

---

## 파일 구조 (예정)

```
src/
├── components/
│   └── sky/
│       ├── SkyDome.jsx           # 3D 구형 하늘
│       ├── Constellation3D.jsx    # 3D 별자리 렌더링
│       └── SkyControls.jsx        # 드래그/자이로 컨트롤
├── pages/
│   ├── SkyPage.jsx               # 3D 밤하늘 메인
│   └── SkyDemoPage.jsx           # 데모 페이지 (현재)
└── hooks/
    └── useDeviceOrientation.js   # 자이로스코프 훅
```

---

## 위치 충돌 로직

### 충돌 판정 방식
```
새 별자리 위치 (ra1, dec1) 등록 시도

기존 별자리들과 각도 거리 계산:
  distance = arccos(sin(dec1)*sin(dec2) + cos(dec1)*cos(dec2)*cos(ra1-ra2))

if (distance < 충돌_반경) → 등록 불가
else → 등록 가능
```

### 충돌 반경 (조정 가능)
- 예: 10° 이내에 다른 별자리 있으면 불가

---

## 메모

- 현재 별자리는 Canvas 2D로 구현되어 있음 (HomePage.jsx)
- 기존 stars, star_connections 테이블 데이터 재활용
- 모바일 웹에서 자이로스코프는 HTTPS 필수
- HomePage에 3D 밤하늘 버튼 추가됨 (/sky)
- 데모 페이지는 /sky-demo로 유지

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-01-27 | 초기 문서 작성 |
| 2026-01-27 | 밤하늘별 수용 인원 개별 설정 기능 추가 |
| 2026-01-27 | Phase 1~4 구현 완료 (DB 적용 제외) |
| 2026-01-27 | 코드 초기화 - 재설계 시작 (Three.js만 유지) |
| 2026-01-27 | 설계 변경: 단일 밤하늘 + 주간 초기화 + 선착순 + 히스토리 |
| 2026-01-28 | 설계 간소화: 주간 초기화/히스토리 제거, 영구 보존 방식으로 변경 |
| 2026-01-28 | 등록 UI 설계: 하이브리드 방식 (3D 터치 선택 + 자동 찾기) |
| 2026-01-28 | 전체 구현 완료: SkyPage.jsx, SQL 마이그레이션, 라우팅 설정 |
| 2026-01-28 | 자이로스코프 구현 완료: AR 카메라 스타일 (핸드폰이 바라보는 방향 = 화면) |
